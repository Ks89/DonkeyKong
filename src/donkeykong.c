/*Copyright 2013-2015 Politecnico di Milano, Stefano Cappa
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

//i can't release this file gaSim.h
#include "gaSim.h"


// Definition of the map. Tile number starts from 0.
// Since it will be hard to insert characters staring from 0,
// we 'shift' the char set to make it easier to define.
// Here, we use 'A' for tile 0, 'B' for tile 1 and so on.
char *map[] = {
		"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
		"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
		"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
		"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
		"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
		"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
		"AABBBBBBBBBBBBBBBBBBBBBBBBBBBBAAAAAAAAAA",
		"AAACAAAAAAAAAACAAAAAAAAACAAAAAAAAAAAAAAA",
		"AAACAAAAAAAAAACAAAAAAAAACAAAAAAAAAAAAAAA",
		"AAACAAAAAAAAAACAAAAAAAAACAAAAAAAAAAAAAAA",
		"AAACAAAAAAAAAACAAAAAAAAACAAAAAAAAAAAAAAA",
		"AAACAAAAAAAAAACAAAAAAAAACAAAAAAAAAAAAAAA",
		"AABBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBAA",
		"AAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAACAAAA",
		"AAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAACAAAA",
		"AAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAACAAAA",
		"AAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAACAAAA",
		"AAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAACAAAA",
		"AAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAACAAAA",
		"AAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAACAAAA",
		"AABBBBBBBBBBBBAABBBBBBBBBBAAAAAABBBBBBAA",
		"AAACAAAAAAAAAAAAAAAAACAAAAAAAAAAAAACAAAA",
		"AAACAAAAAAAAAAAAAAAAACAAAAAAAAAAAAACAAAA",
		"AAACAAAAAAAAAAAAAAAAACAAAAAAAAAAAAACAAAA",
		"AAACAAAAAAAAAAAAAAAAACAAAAAAAAAAAAACAAAA",
		"AAACAAAAAAAAAAAAAAAAACAAAAAAAAAAAAACAAAA",
		"AAACAAAAAAAAAAAAAAAAACAAAAAAAAAAAAACAAAA",
		"AAACAAAAAAAAAAAAAAAAACAAAAAAAAAAAAACAAAA",
		"BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB",
		""
};

// Definition of the tiles required
// by the game. In the braket, it is indicated
// the letter used in the {map[]} array to
// display that tile
unsigned char charset[] = {
		// char 0 - (A) ww/ww
		0x00, 0x00,
		0x00, 0x00,
		0x00, 0x00,
		0x00, 0x00,
		0x00, 0x00,
		0x00, 0x00,
		0x00, 0x00,
		0x00, 0x00,
		// char 1 - (B) ww/wa
		0xff, 0xff,
		0xff, 0xff,
		0x0f, 0xc0,
		0x3c, 0xf0,
		0xf0, 0x3c,
		0xc0, 0x0f,
		0xff, 0xff,
		0xff, 0xff,
		// char 2 - (C) wa/aa
		0x80, 0x02,
		0xaa, 0xaa,
		0x80, 0x02,
		0x80, 0x02,
		0x80, 0x02,
		0xaa, 0xaa,
		0x80, 0x02,
		0x80, 0x02
};

// definition of the sprites used
// in this game: four sprites with
// the player (mario}
unsigned char spriteset[] = {
		// che sta fermo in piedi di profilo verso destra //sprite numero 0
		0x00, 0x3f, 0xc0, 0x00,
		0x00, 0xff, 0xff, 0x00,
		0x00, 0xaa, 0x50, 0x00,
		0x02, 0x59, 0x65, 0x40,
		0x02, 0x5a, 0x59, 0x50,
		0x0a, 0x95, 0x6a, 0x80,
		0x00, 0x15, 0x55, 0x00,
		0x00, 0xaa, 0xa0, 0x00,
		0x02, 0xab, 0xe8, 0x00,
		0x02, 0xaf, 0x7c, 0x00,
		0x02, 0xab, 0xff, 0x00,
		0x0f, 0xa5, 0xff, 0x00,
		0x0f, 0xd7, 0xff, 0x00,
		0x0f, 0xfc, 0xfc, 0x00,
		0x02, 0xa0, 0xa0, 0x00,
		0x02, 0xa8, 0xa8, 0x00,

		// che corre (di profilo) verso destra //sprite numero 1
		0x00, 0x3f, 0xc0, 0x00,
		0x00, 0xff, 0xff, 0x00,
		0x00, 0xaa, 0x50, 0x00,
		0x02, 0x59, 0x65, 0x40,
		0x02, 0x5a, 0x59, 0x50,
		0x0a, 0x95, 0x6a, 0x80,
		0x00, 0x15, 0x55, 0x00,
		0x0a, 0xaf, 0xa0, 0x14,
		0x5a, 0xaf, 0xea, 0x54,
		0x54, 0xad, 0xfe, 0xa4,
		0x50, 0xff, 0xfc, 0x20,
		0x03, 0xff, 0xff, 0xa0,
		0x0f, 0xff, 0xff, 0xa0,
		0x2a, 0xf0, 0x3f, 0xa0,
		0x2a, 0x00, 0x00, 0x00,
		0x0a, 0x80, 0x00, 0x00,

		// che sale la scala //sprite numero 2
		0x01, 0x50, 0x00, 0x00,
		0x01, 0x7f, 0xfc, 0x00,
		0x02, 0xaf, 0xf8, 0x00,
		0x0a, 0xaa, 0xaa, 0x00,
		0x0a, 0xaa, 0xaa, 0x00,
		0x0a, 0x95, 0x56, 0xa0,
		0x02, 0xba, 0xae, 0xa8,
		0x02, 0xba, 0xae, 0xa8,
		0x03, 0xfe, 0xbf, 0xc0,
		0x0f, 0xff, 0xff, 0xc0,
		0x0f, 0xff, 0xff, 0xc0,
		0x03, 0xff, 0xff, 0xc0,
		0x02, 0xa8, 0xff, 0x00,
		0x00, 0x03, 0xab, 0x00,
		0x00, 0x0a, 0xaa, 0x00,
		0x00, 0x0a, 0xa8, 0x00,

		// che sta saltando verso destra//sprite numero 3
		0x00, 0x3f, 0xc0, 0x00,
		0x00, 0xff, 0xff, 0x00,
		0x00, 0xaa, 0x50, 0x00,
		0x02, 0x59, 0x65, 0x40,
		0x02, 0x5a, 0x59, 0x50,
		0x0a, 0x95, 0x6a, 0x80,
		0x28, 0x05, 0x55, 0x45,
		0x56, 0xaa, 0xe8, 0x25,
		0x04, 0xab, 0xfa, 0xa8,
		0x00, 0x2b, 0x7f, 0x00,
		0x0a, 0x3f, 0xff, 0x02,
		0x2a, 0xbf, 0xff, 0xfa,
		0xa3, 0xff, 0xff, 0xfa,
		0x00, 0xff, 0x00, 0x00,
		0x00, 0x3c, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,

		// che corre (di profilo) verso sinistra //sprite numero 4
		0x00, 0x03, 0xfc, 0x00,
		0x00, 0xff, 0xff, 0x00,
		0x00, 0x05, 0xaa, 0x00,
		0x01, 0x59, 0x65, 0x80,
		0x05, 0x65, 0xa5, 0x80,
		0x02, 0xa9, 0x56, 0xa0,
		0x00, 0x55, 0x58, 0x00,
		0x14, 0x0a, 0xfa, 0xa0,
		0x15, 0xab, 0xfa, 0xa5,
		0x16, 0xbf, 0x7a, 0x15,
		0x08, 0x3f, 0xff, 0x05,
		0x0a, 0xff, 0xff, 0xc0,
		0x0a, 0xff, 0xff, 0xf0,
		0x0a, 0xfc, 0x0f, 0xa8,
		0x00, 0x00, 0x00, 0xa8,
		0x00, 0x00, 0x02, 0xa0,

		// che sta fermo in piedi di profilo verso sinistra //sprite numero 5
		0x00, 0x03, 0xfc, 0x00,
		0x00, 0xff, 0xff, 0x00,
		0x00, 0x05, 0xaa, 0x00,
		0x01, 0x59, 0x65, 0x80,
		0x05, 0x65, 0xa5, 0x80,
		0x02, 0xa9, 0x56, 0xa0,
		0x00, 0x55, 0x54, 0x00,
		0x00, 0x0a, 0xaa, 0x00,
		0x00, 0x2b, 0xea, 0x80,
		0x00, 0x3d, 0xfa, 0x80,
		0x00, 0xff, 0xea, 0x80,
		0x00, 0xff, 0x56, 0xc0,
		0x00, 0xff, 0xd3, 0xc0,
		0x00, 0x3f, 0x3f, 0xc0,
		0x00, 0x2a, 0x0a, 0x80,
		0x00, 0xaa, 0x2a, 0x80,

		// che sta saltando verso sinistra //sprite numero 6
		0x00, 0x0f, 0xf0, 0x00,
		0x03, 0xff, 0xfc, 0x00,
		0x00, 0x16, 0xa8, 0x00,
		0x05, 0x65, 0x96, 0x00,
		0x15, 0x96, 0x96, 0x00,
		0x0a, 0xa5, 0x5a, 0x80,
		0x51, 0x55, 0x50, 0x14,
		0x58, 0x2b, 0xaa, 0x95,
		0x2a, 0xaf, 0xea, 0x10,
		0x00, 0xfd, 0xe8, 0x00,
		0x80, 0xff, 0xfc, 0xa0,
		0xaf, 0xff, 0xfe, 0xa8,
		0xaf, 0xff, 0xff, 0xca,
		0x00, 0x00, 0xff, 0x00,
		0x00, 0x00, 0x3c, 0x00,
		0x00, 0x00, 0x00, 0x00,


		// donkey kong alto sinitra //sprite numero 7
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x03,
		0x00, 0x00, 0x00, 0x17,
		0x00, 0x00, 0x00, 0x57,
		0x00, 0x00, 0x00, 0x57,
		0x00, 0x00, 0x07, 0xf5,
		0x00, 0x00, 0x5f, 0xd6,
		0x00, 0x01, 0xff, 0xda,
		0x00, 0x17, 0xff, 0xde,
		0x00, 0x7f, 0xff, 0xf6,
		0x01, 0xff, 0xff, 0xfd,
		0x03, 0xff, 0xdf, 0xff,
		0x03, 0xff, 0xf7, 0xff,
		0x03, 0xff, 0xfd, 0x5f,

		// donkey kong basso sinitra //sprite numero 8
		0x00, 0xff, 0xff, 0xfd,
		0x00, 0x3f, 0xff, 0xff,
		0x00, 0x0f, 0xff, 0xff,
		0x00, 0x00, 0x3f, 0xff,
		0x00, 0x01, 0x7f, 0xf5,
		0x00, 0x17, 0xff, 0xfd,
		0x00, 0x7f, 0xff, 0xff,
		0x00, 0x7f, 0xff, 0xff,
		0x00, 0x7f, 0xff, 0xff,
		0x00, 0x7f, 0xff, 0xff,
		0x03, 0xff, 0xff, 0xff,
		0x15, 0xff, 0xff, 0x00,
		0x57, 0x57, 0xfc, 0x00,
		0x55, 0x5d, 0x54, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,

		// donkey kong basso centrale //sprite numero 9
		0x55, 0xfd, 0x55, 0xff,
		0x75, 0x75, 0x77, 0xff,
		0xd5, 0x75, 0x5f, 0xff,
		0x75, 0x75, 0x77, 0xff,
		0x55, 0xdd, 0x55, 0x7f,
		0x57, 0x57, 0x55, 0xff,
		0xf5, 0x55, 0x7f, 0xff,
		0x5d, 0xfd, 0xd7, 0xff,
		0xf7, 0xdf, 0x7f, 0xff,
		0x7d, 0xfd, 0xf7, 0xff,
		0x00, 0x00, 0x03, 0xff,
		0x00, 0x00, 0x00, 0x03,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,


		// donkey kong basso destra //sprite numero 10
		0xff, 0xfc, 0x00, 0x00,
		0xff, 0xf0, 0x00, 0x00,
		0xff, 0x00, 0x00, 0x00,
		0xf0, 0x00, 0x00, 0x00,
		0xf5, 0x00, 0x00, 0x00,
		0xff, 0x50, 0x00, 0x00,
		0xff, 0xf4, 0x00, 0x00,
		0xff, 0xf4, 0x00, 0x00,
		0xff, 0xf4, 0x00, 0x00,
		0xff, 0xf4, 0x00, 0x00,
		0xff, 0xff, 0x00, 0x00,
		0xff, 0xfd, 0x50, 0x00,
		0xff, 0x57, 0x54, 0x00,
		0x55, 0xd5, 0x54, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,

		// donkey kong alto destra //sprite numero 11
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x40, 0x00, 0x00, 0x00,
		0xd4, 0x00, 0x00, 0x00,
		0xfd, 0x00, 0x00, 0x00,
		0xff, 0x50, 0x00, 0x00,
		0xff, 0xf4, 0x00, 0x00,
		0xff, 0xfd, 0x00, 0x00,
		0xdf, 0xff, 0x00, 0x00,
		0x7f, 0xff, 0x00, 0x00,
		0xff, 0xff, 0x00, 0x00,


		// donkey kong alto centrale (cioe' la testa dello scimmione) //sprite numero 12
		0x0f, 0xff, 0xc0, 0x00,
		0x3f, 0xff, 0xf0, 0x00,
		0xf5, 0xfd, 0x7c, 0x00,
		0xd5, 0x75, 0x5f, 0x00,
		0x56, 0x9a, 0x57, 0x50,
		0xd6, 0x12, 0x5f, 0x54,
		0xd5, 0x55, 0x5f, 0x54,
		0x55, 0xfd, 0x55, 0x7f,
		0x95, 0x55, 0x5a, 0x5f,
		0xba, 0xba, 0xba, 0x9f,
		0xfe, 0xfe, 0xfe, 0xdf,
		0xba, 0xba, 0xba, 0x7f,
		0x5a, 0xaa, 0x95, 0xff,
		0xd5, 0x55, 0x5f, 0xff,
		0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xd5,


		// principessa girata verso sinistra parte alta //sprite numero 13
		0x3f, 0xfc, 0x00, 0x00,
		0xff, 0xff, 0x00, 0x00,
		0x2a, 0xbf, 0xc0, 0x00,
		0xa2, 0xbb, 0xc0, 0xf0,
		0x2a, 0xaf, 0x03, 0xc0,
		0x0a, 0xab, 0xff, 0x00,
		0x00, 0xa9, 0xff, 0xf0,
		0x01, 0xa5, 0x7f, 0xc0,
		0x01, 0x55, 0x43, 0x30,
		0x00, 0x55, 0x40, 0x00,
		0xa5, 0x55, 0x00, 0x00,
		0x25, 0x40, 0x00, 0x00,
		0x01, 0x55, 0x50, 0x00,
		0x29, 0x55, 0x55, 0x00,
		0x25, 0x55, 0x56, 0x94,
		0x05, 0x55, 0x6a, 0x58,

		// principessa girata verso sinistra parte bassa //sprite numero 14
		0x05, 0x56, 0xa5, 0x60,
		0x05, 0x6a, 0x55, 0x40,
		0x0a, 0xa5, 0x67, 0xf0,
		0x05, 0x56, 0x83, 0xc0,
		0x0a, 0xa8, 0x0f, 0x00,
		0x3f, 0x30, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
};

// The palette used for the game.
// we need 3 four-colors palettes:
// one for the tile drawn normally
// one for the "painted" tiles
// one for the mario sprite
unsigned char colors[] = {
		// normal tiles
		0x00, 0x00, 0x00, //nero
		0x00, 0x00, 0x00, //nero
		0x60, 0xd0, 0xd0, //cyan
		0xd8, 0x40, 0x60, //rosa

		// donkeykong sprite
		0x00, 0x00, 0x00, //nero
		0xfc, 0xbc, 0xb0, //rosa
		0xff, 0xff, 0xff, //bianco
		0xa4, 0x00, 0x00, //marrone

		// mario sprite
		0x00, 0x00, 0x00, //nero
		0xf0, 0xd0, 0xb0, //rosa
		0x00, 0x00, 0xbf, //blu
		0xf8, 0x38, 0x00, //rosso

		// principessa sprite
		0x00, 0x00, 0x00, //nero
		0xf8, 0x78, 0xf5, //rosa
		0xff, 0xff, 0xff, //bianco
		0xfc, 0xa4, 0x43  //arancione
};

void putSprite(int n, int x, int y, int s, int c)
/* put sprite {n} at position {x,y}, using shape {s} and color {c} */
{
	spriteReg[n*6]   = x & 0xff;			// sets the x-lo register
	spriteReg[n*6+1] = (x >> 8) & 0xff;		// sets the x-hi register
	spriteReg[n*6+2] = y & 0xff;			// sets the y-lo register
	spriteReg[n*6+3] = (y >> 8) & 0xff;		// sets the y-hi register
	spriteReg[n*6+4] = s;					// sets the sprite number register
	spriteReg[n*6+5] = c;					// sets the sprite color register
}

void paletteRect(int r, int c, int w, int h, int p)
/* sets the color of the tiles from {r,c} to {r+w-1,c+h-1} to {p} */
{
	int i, j;
	for(i = r; i < r+w; i++) {			// for all the rows of the rectangle
		for(j = c; j < c+h; j++) {			// for all the columns of the rectangle
			videoMemory[j*80+i*2+1] = p;		// sets the color of the tile
			// each row is 80 bytes.
			// even number defines the tile
			// odd numbers the color. In this way
			// the locaion in the video memory
			// corrsponding to tile color in position
			// {r,c} on screen is:
			// {r*80 + c*2}
		}
	}
}

void initScreen()
// sets up the play-field
{
	int r, c;			// row and column of the map
	memcpy(charDef, charset, sizeof(charset));			// copy the tile definitions
	memcpy(spriteDef, spriteset, sizeof(spriteset));	// copy the sprite definitions
	memcpy(videoPalette, colors, sizeof(colors));		// copy the palettes
	*videoMode = VM_TEXT;								// sets the TEXT videomode
	*spriteEnable = 1;									// enable the sprites

	r = 0;
	while(strlen(map[r]) > 0) {			// until the map has an empty row
		for(c = 0; c < strlen(map[r]); c++) {		// copy the row on the screen
			videoMemory[r*80+c*2] = map[r][c] - 'A';	// gets the number of the tile
			// from the map:
			// tiles starts from 0,
			// characters in the map from 'A'
			// so the tile number is {map[r][c] - 'A'}
			// The location in the video memory
			// corresponding to tile in position
			// {r,c} on screen is:
			// {r*80 + c*2}
		}
		r++;		// go to the next row
	}
}			

int main(int argc, char **argv) {
	int qx, qy;		// position of the mario sprite (in pixels)
	int qn;			// number of the sprite of the mario
	int qr, qc;		// row and column of mario (in tyles)
	unsigned char key;		// key pressed
	int running;	// the game is running

	// direction of the movement, depending on
	// the sprite number (which identfies the
	// direction where mario is facing
	static int dx[4] = {0, 0, -1, 1},
			dy[4] = {-1, 1, 0, 0};

	int i;	// for the animation
	int spriteNumber;

	int eseguiMovimento = 1; //se 1 esegueMovimento, se 0 non lo permette
	int verificaSeCade = 0;

	static int jump[16] = {-4, -3, -3, -2, -2, -1, -1, 0, 0, 1, 1, 2, 2, 3, 3, 4};
	// trick to create the jump effect

	initScreen();		// draws

	//posiziono donkey kong
	putSprite(7, 25, 18, 7, 1);
	putSprite(8, 25, 34, 8, 1);
	putSprite(9, 41	, 34, 9, 1);
	putSprite(10, 57, 34, 10, 1);
	putSprite(11, 57, 18, 11, 1);
	putSprite(12, 41, 18, 12, 1);

	//disegno la principessa
	putSprite(13, 73, 26, 13, 3);
	putSprite(14, 73, 42, 14, 3);


	qx = 16;			// set the initial position and direction of the ball
	qy = 208;
	qr =  26;
	qc =  2;

	spriteNumber = 0; //rappresenta il numero della sprite da passare al metodo putSprite.
	//in questo caso rappresenta la sprite iniziale

	running = 1;
	putSprite(0, qx, qy, spriteNumber, 2);		// draws the mario

	while(running) {		// repeat until stopped
		key = waitkey();	// waits for the next input

		eseguiMovimento = 1;
		verificaSeCade = 0;

		if(isKeyPressed('w') || isKeyPressed('W')) {
			if((qr-1>=0 && qr-1<=28) && (qc+1>=0 && qc+1<=39) &&
								((map[qr-1][qc]=='C' || map[qr-1][qc+1]=='C') || ((map[qr][qc]=='B' || map[qr][qc+1]=='B')) )) {
							qn = 0;
							spriteNumber = 2;
							eseguiMovimento = 1;
						} else {
							eseguiMovimento = 0;
						}
		} else if(isKeyPressed('s') || isKeyPressed('S')) {
			if((qr+3>=0 && qr+3<=28) && (qc+1>=0 && qc+1<=39) &&
								((map[qr+3][qc]=='C' || map[qr+3][qc+1]=='C') //se sotto alla sprite (cioe' a +3) ho una C (scala) posso scendere
										|| ((map[qr+2][qc]=='B' || map[qr+2][qc+1]=='B') && (map[qr+3][qc]=='C' || map[qr+3][qc+1]=='C') ) )) {
							qn = 1;
							spriteNumber = 2;
							eseguiMovimento = 1;
						} else {
							eseguiMovimento = 0;
						}
		} else if(isKeyPressed('a') || isKeyPressed('A')) {
			if((qr>=0 && qr<=28) && (qc-2>=0 && qc-2<=39)) {
							qn = 2;
							spriteNumber = 4;
							eseguiMovimento = 1;
							verificaSeCade = 1;
						} else {
							eseguiMovimento = 0;
							verificaSeCade = 0;
						}
		} else if(isKeyPressed('d') || isKeyPressed('D')) {
			if((qr>=0 && qr<=28) && (qc+2>=0 && qc+2<=39)) {
							qn = 3;
							spriteNumber = 1;
							eseguiMovimento = 1;
							verificaSeCade = 1;
						} else {
							eseguiMovimento = 0;
							verificaSeCade = 0;
						}
		} else if(isKeyPressed(27)) {
			running = 0;
		} else if(isKeyPressed(32)) {
			if((spriteNumber==4 || spriteNumber==5) && (qr>=0 && qr<=28) && (qc-4>=0 && qc-4<=39)) {
								//salta a sinistra
								qn = 2;
								spriteNumber = 6;
								eseguiMovimento = 1;
								verificaSeCade = 1;
							} else {
								if((spriteNumber==0 || spriteNumber==1) && (qr>=0 && qr<=28) && (qc+4>=0 && qc+4<=39)) {
									//salta a destra
									qn = 3;
									spriteNumber = 3;
									eseguiMovimento = 1;
									verificaSeCade = 1;
								} else {
									verificaSeCade = 0;
									eseguiMovimento = 0;
								}
							}
		}

		if(eseguiMovimento==1) {
			for(i = 0; i < 16; i++) {

				// eseguo un salto
				if(spriteNumber == 3 || spriteNumber == 6) {
					qx += 2*dx[qn];
					qy += jump[i] + ((i % 2 == 0) ? dy[qn] : 2*dy[qn]);
				} else { //mi muovo normalmente camminando
					qx += dx[qn];
					qy += dy[qn];
				}

				putSprite(0, qx, qy, spriteNumber, 2);		// draws mario. 2 perche' mario e' la seconda sprite
				waitMsec(20);			// waits a frame
			}


			switch(qn) {
			case 3 :// se mi sono mosso a destra
				spriteNumber = 0;
				break;
			case 2 :// se mi sono mosso a sinistra
				spriteNumber = 5;
				break;
			default :
				spriteNumber = 0;
				break;
			}

			qr =  qy/8;
			qc =  qx/8;

			printf("X: %d , Y: %d \n", qx, qy);
			printf("row: %d , col: %d \n", qr, qc);

			printf("%c %c %c %c\n", map[qr-1][qc-1], map[qr-1][qc], map[qr-1][qc+1], map[qr-1][qc+2]);
			printf("%c %c %c %c\n", map[qr][qc-1], map[qr][qc], map[qr][qc+1], map[qr][qc+2]);
			printf("%c %c %c %c\n", map[qr+1][qc-1], map[qr+1][qc], map[qr+1][qc+1], map[qr+1][qc+2]);
			printf("%c %c %c %c\n", map[qr+2][qc-1], map[qr+2][qc], map[qr+2][qc+1], map[qr+2][qc+2]);

			putSprite(0, qx, qy, spriteNumber, 2);		// draws mario


			printf ("provaAFarCadere: %d\n", verificaSeCade);

			//ora verifico se devo far cadere Mario
			if(verificaSeCade==1 && qr+2>=0 && qr+2<=28 && map[qr+2][qc]=='A') {
				while(map[(qy/8)+2][qc]=='A') {
					qy++;

					putSprite(0, qx, qy, spriteNumber, 2);		// draws mario. 2 perche' mario e' la seconda sprite
					waitMsec(10);			// waits a frame

					qr =  qy/8;
				}
			}


		} else {
			printf("Movimento non permesso \n");
		}
	}
	return 0;
}
